<%- include('../partials/header') %>

<div class="container py-5">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/rooms">Rooms</a></li>
      <li class="breadcrumb-item"><a href="/rooms/<%= room.id %>"><%= room.roomName %></a></li>
      <li class="breadcrumb-item active" aria-current="page">Book Now</li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow border-0">
        <div class="card-header bg-primary text-white py-3">
          <h3 class="card-title mb-0">Book Your Stay</h3>
        </div>
        <div class="card-body p-4">
          <!-- Flash Messages -->
          <% if(success_msg != ''){ %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <%= success_msg %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% } %>
          
          <% if(error_msg != ''){ %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <%= error_msg %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% } %>
          
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="d-flex">
                <img src="<%= room.imageUrl %>" alt="<%= room.roomName %>" class="img-fluid rounded me-3" style="width: 100px; height: 100px; object-fit: cover;">
                <div>
                  <h5 class="mb-1"><%= room.roomName %></h5>
                  <p class="text-muted mb-1">
                    <i class="fas fa-tag me-1"></i> <%= room.roomType ? room.roomType.roomTypeName : 'Standard Room' %>
                  </p>
                  <h6 class="text-primary mb-0">$<%= room.price %> / night</h6>
                </div>
              </div>
            </div>
          </div>
          
          <form action="/bookings/create/<%= room.id %>" method="POST">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="checkInDate" class="form-label">Check-in Date</label>
                <input type="date" class="form-control" id="checkInDate" name="checkInDate" 
                      value="<%= checkIn %>" min="<%= new Date().toISOString().split('T')[0] %>" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="checkOutDate" class="form-label">Check-out Date</label>
                <input type="date" class="form-control" id="checkOutDate" name="checkOutDate" 
                      value="<%= checkOut %>" required>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="numberOfGuests" class="form-label">Number of Guests</label>
                <select class="form-select" id="numberOfGuests" name="numberOfGuests" required>
                  <% for(let i = 1; i <= 4; i++) { %>
                    <option value="<%= i %>" <%= parseInt(guests) === i ? 'selected' : '' %>><%= i %> <%= i === 1 ? 'Guest' : 'Guests' %></option>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentMethod" class="form-label">Payment Method</label>
                <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                  <option value="credit_card">Credit Card</option>
                  <option value="debit_card">Debit Card</option>
                  <option value="paypal">PayPal</option>
                  <option value="cash">Cash (Pay at Hotel)</option>
                </select>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="specialRequests" class="form-label">Special Requests</label>
              <textarea class="form-control" id="specialRequests" name="specialRequests" rows="3" placeholder="Any special requests or preferences?"></textarea>
            </div>
            
            <hr class="my-4">
            
            <div class="booking-summary p-3 mb-4 rounded">
              <h5 class="mb-3">Booking Summary</h5>
              <div class="row mb-2">
                <div class="col-7">Room Rate:</div>
                <div class="col-5 text-end">$<%= room.price %> / night</div>
              </div>
              <div class="row mb-2">
                <div class="col-7">Stay Duration:</div>
                <div class="col-5 text-end"><span id="nightsCount">1</span> nights</div>
              </div>
              <div class="row mb-2">
                <div class="col-7">Room Total:</div>
                <div class="col-5 text-end">$<span id="roomTotal"><%= room.price %></span></div>
              </div>
              <div class="row mb-2">
                <div class="col-7">Taxes & Fees (12%):</div>
                <div class="col-5 text-end">$<span id="taxesAndFees"><%= Math.round(room.price * 0.12) %></span></div>
              </div>
              
              <div class="row fw-bold mt-2 pt-2 border-top">
                <div class="col-7">Total Amount:</div>
                <div class="col-5 text-end">$<span id="totalAmount"><%= room.price + Math.round(room.price * 0.12) %></span></div>
              </div>
            </div>
            
            <div class="form-check mb-4">
              <input class="form-check-input" type="checkbox" id="termsCheck" required>
              <label class="form-check-label" for="termsCheck">
                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">terms and conditions</a>
              </label>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">Confirm Booking</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <h6>Booking Policy</h6>
        <p>By confirming this booking, you agree to the following terms:</p>
        <ul>
          <li>Check-in time is from 3:00 PM and check-out time is until 11:00 AM.</li>
          <li>A valid government-issued photo ID is required at check-in.</li>
          <li>Guests under 18 years of age must be accompanied by a parent or guardian.</li>
          <li>We reserve the right to refuse service to anyone for any reason at any time.</li>
        </ul>
        
        <h6>Cancellation Policy</h6>
        <p>Cancellations made more than 48 hours before the scheduled check-in date will receive a full refund. Cancellations made within 48 hours of the scheduled check-in date will be charged for the first night's stay.</p>
        
        <h6>Payment Policy</h6>
        <p>For reservations with "Pay at Hotel", a valid credit card is required to guarantee the booking. For prepaid reservations, the full amount will be charged at the time of booking.</p>
        
        <h6>Damage Policy</h6>
        <p>Guests will be held responsible for any damage to the hotel property during their stay and will be charged accordingly.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Calculate price based on selected dates
  const checkInInput = document.getElementById('checkInDate');
  const checkOutInput = document.getElementById('checkOutDate');
  const nightsCountElement = document.getElementById('nightsCount');
  const roomTotalElement = document.getElementById('roomTotal');
  const taxesAndFeesElement = document.getElementById('taxesAndFees');
  const totalAmountElement = document.getElementById('totalAmount');
  
  const roomPrice = <%= room.price %>;
  
  function updatePriceCalculation() {
    if (checkInInput.value && checkOutInput.value) {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);
      
      // Calculate nights difference
      const timeDiff = checkOut.getTime() - checkIn.getTime();
      const nights = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      if (nights > 0) {
        // Update display
        nightsCountElement.textContent = nights;
        
        const roomTotal = roomPrice * nights;
        const taxesAndFees = Math.round(roomTotal * 0.12);
        const totalAmount = roomTotal + taxesAndFees;
        
        roomTotalElement.textContent = roomTotal;
        taxesAndFeesElement.textContent = taxesAndFees;
        totalAmountElement.textContent = totalAmount;
      }
    }
  }
  
  // Set min check-out date when check-in date selected
  checkInInput.addEventListener('change', function() {
    if (this.value) {
      const nextDay = new Date(this.value);
      nextDay.setDate(nextDay.getDate() + 1);
      
      const nextDayFormatted = nextDay.toISOString().split('T')[0];
      checkOutInput.min = nextDayFormatted;
      
      // If check-out is before new check-in, update it
      if (checkOutInput.value && new Date(checkOutInput.value) <= new Date(this.value)) {
        checkOutInput.value = nextDayFormatted;
      }
      
      updatePriceCalculation();
    }
  });
  
  // Update price calculation when check-out date changes
  checkOutInput.addEventListener('change', updatePriceCalculation);
  
  // Initialize price calculation
  updatePriceCalculation();
</script>

<%- include('../partials/footer') %>
